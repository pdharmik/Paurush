<?xml version="1.0" encoding="UTF-8" ?>
<project name="testCommon"  basedir=".">
	
	<path id="test.classpath">
		<fileset dir="${tomcat.home}/lib" includes="*.jar" />
		<fileset dir="${tomcat.home}/lib/ext" includes="*.jar" />
		<fileset dir="${lib.dir}" includes="*.jar" />
		<fileset dir="${lexmark.common.project.home}/lib" includes="*.jar" />
	</path>
	
	<path id="cobertura.classpath">
		<fileset dir="${lib.dir}">
			<include name="*.jar" />
			<include name="utest/*.jar" />
		</fileset>
		
	</path>
			
	<taskdef classpathref="cobertura.classpath" resource="tasks.properties"/> 
	
	<target name="compile-test" depends="common-jar,webService-jar">
		<javac srcdir="${test.src.dir}" destdir="${classes.dir}" classpathref="test.classpath" debug="true" />
	</target>
 	
	<target name="init-test">
		<delete dir="${reports.dir}" />
		<mkdir dir="${reports.dir}" />
		<mkdir dir="${reports.dir}/junitxml" />
		<mkdir dir="${reports.dir}/junithtml" />
		<mkdir dir="${reports.dir}/coveragexml" />
		<mkdir dir="${reports.dir}/coveragehtml" />
	</target>
	
	<target name="utest" >
		<junit dir="./" errorproperty="tests.failed" failureproperty="tests.failed" fork="true" showoutput="true">
			<classpath location="${instrumented.dir}"/>
			<classpath location="${classes.dir}"/>
			<classpath refid="test.classpath"/>
			<classpath refid="cobertura.classpath"/>
			<syspropertyset>
				<propertyref prefix="test-sys-prop." />
				<mapper from="test-sys-prop.*" to="*" type="glob" />
			</syspropertyset>
			
			<formatter type="xml"/>
			<test name="${testcase}" todir="${reports.dir}/junitxml" if="testcase"/>
			<batchtest todir="${reports.dir}/junitxml" unless="testcase">
				<fileset dir="${test.src.dir}">
					<include name="com/lexmark/**/*Test.java" />
					<exclude name="com/lexmark/webservice/**/*Test.java" />
					<exclude name="com/lexmark/interceptor/*Test.java" />
					<exclude name="com/lexmark/exception/*Test.java" />
				</fileset>	
			</batchtest>	
		</junit>
		
		<junitreport todir="${reports.dir}/junitxml">
			<fileset dir="${reports.dir}/junitxml">
				<include name="TEST-*.xml"/>
				</fileset>
				<report format="frames" todir="${reports.dir}/junithtml"/>
		</junitreport>	
	</target>
		
 
	<target name="coverage-check">
		<cobertura-check branchrat="65" totallinerate="100"/>	
	</target>	
	
	<target name="coverage-report">
			<cobertura-report srcdir="${src.dir}" destdir="${reports.dir}/coveragexml" format="xml" />	
	</target>
	
	<target name="alternate-coverage-report">
		<cobertura-report destdir="${reports.dir}/coveragehtml">
			<fileset dir="${src.dir}">
				<include name="**/*.java" />
			</fileset>	
		</cobertura-report>
	</target>
	
	<target name="instrument" >
		<delete file="cobertura.ser" />   
		<delete file="${instrumented.dir}" />
		<cobertura-instrument todir="${instrumented.dir}">
			<ignore regex="org.apache.log4j.*" />
			<fileset dir="${classes.dir}">
				<include name="com/lexmark/**/*.class" />
				<exclude name="com/lexmark/webservice/**/*.class" />
				<exclude name="com/lexmark/interceptor/*.class" />
				<exclude name="com/lexmark/exception/*.class" />
				<exclude name="com/lexmark/**/*Test.class" />
			</fileset>
		</cobertura-instrument>
		
		<copy todir="${instrumented.dir}">
			<fileset dir="${classes.dir}" includes="com/lexmark/resources/**/*.TTF" />
		</copy>
	</target>
	
	<target name="coverage" depends="compile,instrument,init-test,compile-test,utest,coverage-report, alternate-coverage-report"/>
	
</project>